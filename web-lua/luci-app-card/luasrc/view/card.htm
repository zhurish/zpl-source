<%#
 Copyright 2008-2009 Steven Barth <steven@midlink.org>
 Copyright 2008-2015 Jo-Philipp Wich <jow@openwrt.org>
 Licensed to the public under the Apache License 2.0.
-%>

<%+cbi/valueheader%>

<%
local sys = require "luci.sys"
local web = require "luci.tools.webadmin"
local fs = require "nixio.fs"

local uci = require "luci.model.uci"
local testing = uci.cursor()

local card_table = { }
local tab_index = 0
local table_max = 0
 
card_table[tab_index] = {
	username    = nil,
	user_id   = nil,
	card_id = nil,
	start_date = nil,
	stop_date = nil,	      
	type = nil,   
	img = nil,      
}
		    	 
function string.split(input, delimiter)
    input = tostring(input)
    delimiter = tostring(delimiter)
    if (delimiter=='') then return false end
    local pos,arr = 0, {}
    -- for each divider found
    for st,sp in function() return string.find(input, delimiter, pos, true) end do
        table.insert(arr, string.sub(input, pos, st - 1))
        pos = sp + 1
    end
    table.insert(arr, string.sub(input, pos))
    return arr
end

if fs.access("/tmp/app/tmp/face-card.txt") then
	for line in io.lines("/tmp/app/tmp/face-card.txt") do
		if line then
			local u = string.split(line," ")
			if u then
				card_table[tab_index] = {
			      username    = u[1],
			      user_id   = u[2],
			      card_id = u[3],
			      start_date = u[4],
			      stop_date = u[5],	      
			      type = u[6],   
			      img = u[7]      
		    	}
	    		tab_index=tab_index+1 
			end
		end
	end
	table_max=tab_index
end

%>

<script type="text/javascript">//<![CDATA[
var selected_ptr=null;

function chk_apply(obj)
{
	selected_ptr=obj;
}

function edit_apply(obj)
{
	var username=null;
	if(selected_ptr != null)
	{
		username=selected_ptr.cells[0].childNodes[0].value;
	}
	else
	{
		username=document.getElementById('username').value;	
	}
	var userid=document.getElementById('userid').value;
	var cardid=document.getElementById('cardid').value;
	var indate=document.getElementById('start_date').value;
	var typeid=document.getElementById('typeid').value;

	var all_value = username + "#" + userid + "#" + cardid + "#" + indate + "#" + typeid + "#";
	alert("input:" + all_value);
}
function delete_apply(obj)
{
	var username=document.getElementById('username').value;
	var userid=document.getElementById('userid').value;
	var cardid=document.getElementById('cardid').value;
	var indate=document.getElementById('start_date').value;
	var typeid=document.getElementById('typeid').value;

	var all_value = username + "#" + userid + "#" + cardid + "#" + indate + "#" + typeid + "#";
	alert("input:" + all_value);
}
</script>
                               
<fieldset class="cbi-section" id="cbi-table-table">
	<div class="cbi-section-descr">
	</div>
	<div class="cbi-section-node">
		<table class="cbi-section-table">
			<tbody>
				<tr class="cbi-section-table-titles">
				<th class="cbi-section-table-cell">Username</th>
				<th class="cbi-section-table-cell">User ID</th>
				<th class="cbi-section-table-cell">Card ID</th>
				<th class="cbi-section-table-cell">StartTime</th>
				<th class="cbi-section-table-cell">StoptTime</th>				
				<th class="cbi-section-table-cell">Type</th>				
				<th class="cbi-section-table-cell">Edit</th>
				<th class="cbi-section-table-cell">Delete</th>
			</tr>
				<tr class="cbi-section-table-descr">
				<th class="cbi-section-table-cell"></th>
				<th class="cbi-section-table-cell"></th>
				<th class="cbi-section-table-cell"></th>
				<th class="cbi-section-table-cell"></th>				
				<th class="cbi-section-table-cell"></th>
				<th class="cbi-section-table-cell"></th>
				<th class="cbi-section-table-cell"></th>
				<th class="cbi-section-table-cell"></th>
			</tr>

			<% for tab_index=0, table_max do 
				if card_table[tab_index].card_id then 
			%>	
			<tr class="cbi-section-table-row cbi-rowstyle-<%=(style and 1 or 2)%>" id="cbi-table" onclick="chk_apply(this);">
				<td class="cbi-value-field">
					<input type="text" class="cbi-input-text" name="username-<%=tab_index%>" id="username-<%=tab_index%>" disabled="true" value="<%=card_table[tab_index].username%>">
				</td>

				<td class="cbi-value-field">
					<input type="text" class="cbi-input-text" name="userid-<%=tab_index%>" id="userid-<%=tab_index%>" disabled="true" value="<%=card_table[tab_index].user_id%>">
				</td>
				
				<td class="cbi-value-field">
					<input type="text"  class="cbi-input-text" name="cardid-<%=tab_index%>" id="cardid-<%=tab_index%>" disabled="true" value="<%=card_table[tab_index].card_id%>">
				</td>

				<td class="cbi-value-field">
					<input type="datetime-local" name="start_date-<%=tab_index%>" id="start_date-<%=tab_index%>" disabled="true" value="<%=card_table[tab_index].start_date%>">
				</td>
				
				<td class="cbi-value-field">
					<input type="datetime-local" name="stop_date-<%=tab_index%>" id="stop_date-<%=tab_index%>" disabled="true" value="<%=card_table[tab_index].stop_date%>">
				</td>
				
				<td class="cbi-value-field">
					<input type="text" class="cbi-input-text" name="typeid-<%=tab_index%>" id="typeid-<%=tab_index%>" disabled="true" value="<%=card_table[tab_index].type%>">
				</td>
				
				<td class="cbi-value-field">
					<input type="submit" class="cbi-button cbi-input-apply" name="apply-<%=tab_index%>" id="apply-<%=tab_index%>" value="Edit" onclick="edit_apply(this)">
				</td>

				<td class="cbi-value-field">
					<input type="submit" class="cbi-button cbi-input-remove" name="delete-<%=tab_index%>" id="delete-<%=tab_index%>" value="Delete" onclick="delete_apply(this)">
				</td>
			</tr>
			<% style = not style 
			end
			end 
			%>
			
		</tbody>
	</table>
</div>
</fieldset>  

<%+cbi/valuefooter%>